<!DOCTYPE html><html><head>
<meta charset="utf-8" />
<link href="https://unpkg.com/maplibre-gl@5.6.0/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@5.6.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.9"></script>
<style>
  html,body,#map{height:100%;margin:0;}
  /* Add custom popup styling */
  .maplibregl-popup-content {
    padding: 15px;
    min-width: 480px;
  }
</style>
</head><body><div id="map"></div>
<script>
// Configure API base URL - allows for easy switching between environments
const apiBaseUrl = window.location.hostname === 'localhost' 
  ? 'http://localhost:5000' 
  : '/api'; // In production, assuming API is proxied under /api

const map = new maplibregl.Map({
  container: 'map',
  style: {
    'version': 8,
    'sources': {
      'osm': {
        'type': 'raster',
        'tiles': ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
        'tileSize': 256,
        'attribution': 'Â© OpenStreetMap contributors'
      }
    },
    'layers': [
      {
        'id': 'osm',
        'type': 'raster',
        'source': 'osm',
        'minzoom': 0,
        'maxzoom': 19
      }
    ]
  },
  center: [0, 20],
  zoom: 2
});

map.on('load', () => {
  // Use GeoJSON directly since tiles aren't supported
  map.addSource('pts', {
    type: 'geojson',
    data: `${apiBaseUrl}/collections/points/items?f=json&limit=1000`
  });
  
  map.addLayer({
    id: 'pt', 
    type: 'circle', 
    source: 'pts',
    paint: {'circle-radius': 5, 'circle-color': '#FF0000', 'circle-stroke-width': 1, 'circle-stroke-color': '#FFFFFF'}
  });

  // Add controls
  map.addControl(new maplibregl.NavigationControl(), 'top-right');
  map.addControl(new maplibregl.ScaleControl(), 'bottom-left');

  map.on('click','pt', e=>{
    const fid=e.features[0].properties.id;
    fetch(`${apiBaseUrl}/collections/points/items/${fid}`)
      .then(r=>r.json()).then(f=>{
        const html='<canvas id="c" width="460" height="200"></canvas>';
        new maplibregl.Popup({
          maxWidth: '500px',
          className: 'chart-popup'
        })
        .setLngLat(e.lngLat)
        .setHTML(html)
        .addTo(map);
        
        new Chart(document.getElementById('c'),{
          type:'bar',
          data:{labels:['p1','p2','p3'],
                datasets:[{data:[f.properties.prop1,
                                  f.properties.prop2,
                                  f.properties.prop3]}]},
          options:{responsive:false,plugins:{legend:{display:false}}}
        });
      });
  });
});
</script></body></html>
